# åº“å­˜æ‰£å‡å®ç°æ–¹æ¡ˆ - ä¹è§‚é” + åˆ†å¸ƒå¼é”

## ğŸ“‹ å®ç°æ¸…å•

### 1. æ•°æ®åº“å˜æ›´
- [ ] ç»™ `sessions` è¡¨æ·»åŠ  `version` å­—æ®µï¼ˆä¹è§‚é”ç‰ˆæœ¬å·ï¼‰

### 2. å®ä½“ç±»æ›´æ–°
- [ ] åœ¨ `Sessions` å®ä½“ç±»æ·»åŠ  `version` å­—æ®µ

### 3. Redis åˆ†å¸ƒå¼é”å·¥å…·ç±»
- [ ] åœ¨ `RedisUtil` ä¸­æ·»åŠ åˆ†å¸ƒå¼é”æ–¹æ³•

### 4. Mapper å±‚
- [ ] æ·»åŠ åº“å­˜æ‰£å‡çš„ SQLï¼ˆå¸¦ä¹è§‚é”ï¼‰

### 5. Service å±‚
- [ ] å®ç°åº“å­˜æ‰£å‡æœåŠ¡æ–¹æ³•ï¼ˆä½¿ç”¨åˆ†å¸ƒå¼é” + ä¹è§‚é”ï¼‰

### 6. è®¢å•æµç¨‹é›†æˆ
- [ ] ä¸‹å•æ—¶é¢„æ‰£åº“å­˜ï¼ˆå¯é€‰ï¼‰
- [ ] æ”¯ä»˜æˆåŠŸæ—¶ç¡®è®¤æ‰£å‡åº“å­˜
- [ ] è®¢å•å–æ¶ˆ/è¶…æ—¶æ—¶å›é€€åº“å­˜

---

## ğŸ—„ï¸ 1. æ•°æ®åº“å˜æ›´

### SQL è„šæœ¬

```sql
-- ç»™ sessions è¡¨æ·»åŠ  version å­—æ®µï¼ˆä¹è§‚é”ç‰ˆæœ¬å·ï¼‰
ALTER TABLE sessions 
ADD COLUMN version INT DEFAULT 0 COMMENT 'ä¹è§‚é”ç‰ˆæœ¬å·';

-- åˆå§‹åŒ–ç°æœ‰æ•°æ®çš„ version å­—æ®µ
UPDATE sessions SET version = 0 WHERE version IS NULL;
```

---

## ğŸ“¦ 2. å®ä½“ç±»æ›´æ–°

### Sessions.java

```java
package com.fuzhou.pojo.entity;
import lombok.Data;
import java.time.LocalDateTime;
import java.time.Duration;

/**
 * èŠ‚ç›®åœºæ¬¡å®ä½“ç±»
 * å¯¹åº”æ•°æ®åº“ sessions è¡¨
 */
@Data
public class Sessions {
    /**
     * ä¸»é”® IDï¼ˆè‡ªå¢ï¼‰
     */
    private Long id;

    /**
     * å…³è”èŠ‚ç›® IDï¼ˆå¯¹åº” show è¡¨çš„ idï¼‰
     */
    private Long showId;

    /**
     * åœºæ¬¡å¼€å§‹æ—¶é—´
     */
    private LocalDateTime startTime;

    /**
     * åœºæ¬¡æŒç»­æ—¶é—´
     */
    private Duration duration;

    /**
     * å‰©ä½™åº“å­˜ï¼ˆå¯å”®ç¥¨æ•°ï¼‰
     */
    private Integer stock;

    /**
     * åˆå§‹åº“å­˜ï¼ˆæ€»ç¥¨æ•°ï¼‰
     * ç”¨äºè®¡ç®—å·²å”®æ•°é‡ï¼šå·²å”® = åˆå§‹åº“å­˜ - å‰©ä½™åº“å­˜
     */
    private Integer totalStock;

    /**
     * ä¹è§‚é”ç‰ˆæœ¬å·
     * æ¯æ¬¡æ›´æ–°æ—¶è‡ªåŠ¨ +1ï¼Œç”¨äºé˜²æ­¢å¹¶å‘æ›´æ–°å†²çª
     */
    private Integer version;
}
```

---

## ğŸ”§ 3. Redis åˆ†å¸ƒå¼é”å·¥å…·ç±»

### RedisUtil.java æ·»åŠ æ–¹æ³•

```java
// ============================ åˆ†å¸ƒå¼é”æ“ä½œ ============================

/**
 * å°è¯•è·å–åˆ†å¸ƒå¼é”ï¼ˆéé˜»å¡ï¼‰
 * @param key é”çš„ Keyï¼ˆå»ºè®®æ ¼å¼ï¼šlock:session:{sessionId}ï¼‰
 * @param value é”çš„å€¼ï¼ˆå»ºè®®ä½¿ç”¨ UUIDï¼Œç”¨äºé‡Šæ”¾é”æ—¶éªŒè¯ï¼‰
 * @param expireTime é”çš„è¿‡æœŸæ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰
 * @return true=è·å–æˆåŠŸï¼Œfalse=è·å–å¤±è´¥ï¼ˆé”å·²è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼‰
 */
public boolean tryLock(String key, String value, long expireTime) {
    try {
        // ä½¿ç”¨ SET key value NX EX å‘½ä»¤ï¼šå¦‚æœ key ä¸å­˜åœ¨åˆ™è®¾ç½®ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´
        // NXï¼šåªåœ¨é”®ä¸å­˜åœ¨æ—¶è®¾ç½®
        // EXï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
        Boolean result = stringRedisTemplate.opsForValue()
            .setIfAbsent(key, value, expireTime, TimeUnit.SECONDS);
        return Boolean.TRUE.equals(result);
    } catch (Exception e) {
        log.error("Redis è·å–åˆ†å¸ƒå¼é”å¤±è´¥ï¼škey={}, value={}, expireTime={}", key, value, expireTime, e);
        return false;
    }
}

/**
 * é‡Šæ”¾åˆ†å¸ƒå¼é”
 * @param key é”çš„ Key
 * @param value é”çš„å€¼ï¼ˆå¿…é¡»ä¸è·å–é”æ—¶çš„å€¼ä¸€è‡´ï¼Œé˜²æ­¢è¯¯é‡Šæ”¾å…¶ä»–çº¿ç¨‹çš„é”ï¼‰
 * @return true=é‡Šæ”¾æˆåŠŸï¼Œfalse=é‡Šæ”¾å¤±è´¥
 */
public boolean releaseLock(String key, String value) {
    try {
        // ä½¿ç”¨ Lua è„šæœ¬ä¿è¯åŸå­æ€§ï¼šåªæœ‰ value åŒ¹é…æ—¶æ‰åˆ é™¤ key
        String luaScript = 
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "    return redis.call('del', KEYS[1]) " +
            "else " +
            "    return 0 " +
            "end";
        Long result = stringRedisTemplate.execute(
            new DefaultRedisScript<>(luaScript, Long.class),
            Collections.singletonList(key),
            value
        );
        return result != null && result > 0;
    } catch (Exception e) {
        log.error("Redis é‡Šæ”¾åˆ†å¸ƒå¼é”å¤±è´¥ï¼škey={}, value={}", key, value, e);
        return false;
    }
}

/**
 * è‡ªåŠ¨é‡Šæ”¾é”çš„åŒ…è£…æ–¹æ³•ï¼ˆæ¨èä½¿ç”¨ï¼‰
 * ä½¿ç”¨ try-with-resources æ¨¡å¼ï¼Œè‡ªåŠ¨é‡Šæ”¾é”
 * 
 * ä½¿ç”¨ç¤ºä¾‹ï¼š
 * try (RedisLock lock = redisUtil.acquireLock("lock:session:1", 30)) {
 *     if (lock.isLocked()) {
 *         // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
 *     }
 * }
 */
public RedisLock acquireLock(String key, long expireTime) {
    String value = UUID.randomUUID().toString();
    boolean locked = tryLock(key, value, expireTime);
    return new RedisLock(key, value, locked, this);
}

/**
 * åˆ†å¸ƒå¼é”åŒ…è£…ç±»ï¼ˆå†…éƒ¨ç±»ï¼‰
 */
public static class RedisLock implements AutoCloseable {
    private final String key;
    private final String value;
    private final boolean locked;
    private final RedisUtil redisUtil;

    private RedisLock(String key, String value, boolean locked, RedisUtil redisUtil) {
        this.key = key;
        this.value = value;
        this.locked = locked;
        this.redisUtil = redisUtil;
    }

    public boolean isLocked() {
        return locked;
    }

    @Override
    public void close() {
        if (locked) {
            redisUtil.releaseLock(key, value);
        }
    }
}
```

**æ³¨æ„**ï¼šéœ€è¦æ·»åŠ å¯¼å…¥ï¼š
```java
import org.springframework.data.redis.core.script.DefaultRedisScript;
import java.util.UUID;
import java.util.Collections;
```

---

## ğŸ“ 4. Mapper å±‚

### SessionsMapper.java

```java
package com.fuzhou.server.mapper;

import com.fuzhou.pojo.entity.Sessions;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

@Mapper
public interface SessionsMapper {
    /**
     * æ ¹æ®IDæŸ¥è¯¢åœºæ¬¡ï¼ˆåŒ…å«ç‰ˆæœ¬å·ï¼‰
     */
    Sessions selectById(Long id);

    /**
     * æ‰£å‡åº“å­˜ï¼ˆä½¿ç”¨ä¹è§‚é”ï¼‰
     * @param sessionId åœºæ¬¡ID
     * @param quantity æ‰£å‡æ•°é‡
     * @param version å½“å‰ç‰ˆæœ¬å·
     * @return æ›´æ–°å½±å“çš„è¡Œæ•°ï¼ˆ0=æ›´æ–°å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç‰ˆæœ¬å·ä¸åŒ¹é…æˆ–åº“å­˜ä¸è¶³ï¼‰
     */
    int decreaseStock(@Param("sessionId") Long sessionId, 
                      @Param("quantity") Integer quantity, 
                      @Param("version") Integer version);

    /**
     * å›é€€åº“å­˜ï¼ˆè®¢å•å–æ¶ˆæ—¶ä½¿ç”¨ï¼‰
     * @param sessionId åœºæ¬¡ID
     * @param quantity å›é€€æ•°é‡
     * @return æ›´æ–°å½±å“çš„è¡Œæ•°
     */
    int increaseStock(@Param("sessionId") Long sessionId, 
                      @Param("quantity") Integer quantity);
}
```

### SessionsMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fuzhou.server.mapper.SessionsMapper">

    <!-- æ ¹æ®IDæŸ¥è¯¢åœºæ¬¡ -->
    <select id="selectById" resultType="com.fuzhou.pojo.entity.Sessions">
        SELECT id, show_id, start_time, duration, stock, total_stock, version
        FROM sessions
        WHERE id = #{id}
    </select>

    <!-- æ‰£å‡åº“å­˜ï¼ˆä½¿ç”¨ä¹è§‚é”ï¼‰ -->
    <update id="decreaseStock">
        UPDATE sessions
        SET stock = stock - #{quantity},
            version = version + 1
        WHERE id = #{sessionId}
          AND stock >= #{quantity}
          AND version = #{version}
    </update>

    <!-- å›é€€åº“å­˜ -->
    <update id="increaseStock">
        UPDATE sessions
        SET stock = stock + #{quantity},
            version = version + 1
        WHERE id = #{sessionId}
          AND stock + #{quantity} <= total_stock
    </update>

</mapper>
```

---

## ğŸ¯ 5. Service å±‚

### SessionsService.java

```java
package com.fuzhou.server.service;

import com.fuzhou.pojo.entity.Sessions;

public interface SessionsService {
    /**
     * æ‰£å‡åº“å­˜ï¼ˆå¸¦åˆ†å¸ƒå¼é”å’Œä¹è§‚é”ï¼‰
     * @param sessionId åœºæ¬¡ID
     * @param quantity æ‰£å‡æ•°é‡
     * @return true=æ‰£å‡æˆåŠŸï¼Œfalse=æ‰£å‡å¤±è´¥ï¼ˆåº“å­˜ä¸è¶³æˆ–å¹¶å‘å†²çªï¼‰
     */
    boolean decreaseStock(Long sessionId, Integer quantity);

    /**
     * å›é€€åº“å­˜ï¼ˆè®¢å•å–æ¶ˆæ—¶ä½¿ç”¨ï¼‰
     * @param sessionId åœºæ¬¡ID
     * @param quantity å›é€€æ•°é‡
     * @return true=å›é€€æˆåŠŸï¼Œfalse=å›é€€å¤±è´¥
     */
    boolean increaseStock(Long sessionId, Integer quantity);

    /**
     * æŸ¥è¯¢åœºæ¬¡ä¿¡æ¯ï¼ˆåŒ…å«åº“å­˜ï¼‰
     * @param sessionId åœºæ¬¡ID
     * @return åœºæ¬¡ä¿¡æ¯
     */
    Sessions getById(Long sessionId);
}
```

### SessionsServiceImpl.java

```java
package com.fuzhou.server.service.impl;

import com.fuzhou.common.exception.BaseException;
import com.fuzhou.common.utils.RedisUtil;
import com.fuzhou.pojo.entity.Sessions;
import com.fuzhou.server.mapper.SessionsMapper;
import com.fuzhou.server.service.SessionsService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Slf4j
@Service
public class SessionsServiceImpl implements SessionsService {

    @Autowired
    private SessionsMapper sessionsMapper;

    @Autowired
    private RedisUtil redisUtil;

    // åˆ†å¸ƒå¼é” Key å‰ç¼€
    private static final String LOCK_KEY_PREFIX = "lock:session:";
    // é”çš„è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
    private static final long LOCK_EXPIRE_TIME = 30;
    // ä¹è§‚é”é‡è¯•æ¬¡æ•°
    private static final int MAX_RETRY_TIMES = 3;

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean decreaseStock(Long sessionId, Integer quantity) {
        if (sessionId == null || quantity == null || quantity <= 0) {
            throw new BaseException("å‚æ•°é”™è¯¯ï¼šåœºæ¬¡IDå’Œæ‰£å‡æ•°é‡ä¸èƒ½ä¸ºç©ºä¸”å¿…é¡»å¤§äº0");
        }

        String lockKey = LOCK_KEY_PREFIX + sessionId;

        // ä½¿ç”¨åˆ†å¸ƒå¼é”
        try (RedisUtil.RedisLock lock = redisUtil.acquireLock(lockKey, LOCK_EXPIRE_TIME)) {
            if (!lock.isLocked()) {
                log.warn("è·å–åˆ†å¸ƒå¼é”å¤±è´¥ï¼šsessionId={}", sessionId);
                return false;
            }

            // åœ¨é”å†…æ‰§è¡Œåº“å­˜æ‰£å‡ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
            for (int i = 0; i < MAX_RETRY_TIMES; i++) {
                // 1. æŸ¥è¯¢å½“å‰åº“å­˜å’Œç‰ˆæœ¬å·
                Sessions session = sessionsMapper.selectById(sessionId);
                if (session == null) {
                    throw new BaseException("åœºæ¬¡ä¸å­˜åœ¨ï¼šsessionId=" + sessionId);
                }

                // 2. æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
                if (session.getStock() < quantity) {
                    log.warn("åº“å­˜ä¸è¶³ï¼šsessionId={}, å½“å‰åº“å­˜={}, éœ€è¦æ•°é‡={}", 
                        sessionId, session.getStock(), quantity);
                    return false;
                }

                // 3. ä½¿ç”¨ä¹è§‚é”æ‰£å‡åº“å­˜
                int updateCount = sessionsMapper.decreaseStock(
                    sessionId, 
                    quantity, 
                    session.getVersion()
                );

                // 4. åˆ¤æ–­æ›´æ–°æ˜¯å¦æˆåŠŸ
                if (updateCount > 0) {
                    log.info("åº“å­˜æ‰£å‡æˆåŠŸï¼šsessionId={}, æ‰£å‡æ•°é‡={}, å‰©ä½™åº“å­˜={}", 
                        sessionId, quantity, session.getStock() - quantity);
                    return true;
                } else {
                    // æ›´æ–°å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ç‰ˆæœ¬å·å†²çªï¼‰ï¼Œé‡è¯•
                    log.warn("åº“å­˜æ‰£å‡å¤±è´¥ï¼ˆç‰ˆæœ¬å†²çªï¼‰ï¼Œå‡†å¤‡é‡è¯•ï¼šsessionId={}, é‡è¯•æ¬¡æ•°={}/{}", 
                        sessionId, i + 1, MAX_RETRY_TIMES);
                    
                    // çŸ­æš‚ä¼‘çœ åé‡è¯•ï¼ˆé¿å…ç«‹å³é‡è¯•å¯¼è‡´æ— æ•ˆç«äº‰ï¼‰
                    if (i < MAX_RETRY_TIMES - 1) {
                        try {
                            Thread.sleep(10 + i * 5); // é€’å¢ä¼‘çœ æ—¶é—´ï¼š10ms, 15ms, 20ms
                        } catch (InterruptedException e) {
                            Thread.currentThread().interrupt();
                            return false;
                        }
                    }
                }
            }

            // é‡è¯•æ¬¡æ•°ç”¨å®Œï¼Œæ‰£å‡å¤±è´¥
            log.error("åº“å­˜æ‰£å‡å¤±è´¥ï¼ˆé‡è¯•æ¬¡æ•°ç”¨å°½ï¼‰ï¼šsessionId={}, quantity={}", sessionId, quantity);
            return false;

        } catch (Exception e) {
            log.error("åº“å­˜æ‰£å‡å¼‚å¸¸ï¼šsessionId={}, quantity={}", sessionId, quantity, e);
            throw new BaseException("åº“å­˜æ‰£å‡å¤±è´¥ï¼š" + e.getMessage());
        }
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean increaseStock(Long sessionId, Integer quantity) {
        if (sessionId == null || quantity == null || quantity <= 0) {
            throw new BaseException("å‚æ•°é”™è¯¯ï¼šåœºæ¬¡IDå’Œå›é€€æ•°é‡ä¸èƒ½ä¸ºç©ºä¸”å¿…é¡»å¤§äº0");
        }

        try {
            int updateCount = sessionsMapper.increaseStock(sessionId, quantity);
            if (updateCount > 0) {
                log.info("åº“å­˜å›é€€æˆåŠŸï¼šsessionId={}, å›é€€æ•°é‡={}", sessionId, quantity);
                return true;
            } else {
                log.warn("åº“å­˜å›é€€å¤±è´¥ï¼šsessionId={}, quantity={}", sessionId, quantity);
                return false;
            }
        } catch (Exception e) {
            log.error("åº“å­˜å›é€€å¼‚å¸¸ï¼šsessionId={}, quantity={}", sessionId, quantity, e);
            throw new BaseException("åº“å­˜å›é€€å¤±è´¥ï¼š" + e.getMessage());
        }
    }

    @Override
    public Sessions getById(Long sessionId) {
        if (sessionId == null) {
            throw new BaseException("åœºæ¬¡IDä¸èƒ½ä¸ºç©º");
        }
        return sessionsMapper.selectById(sessionId);
    }
}
```

---

## ğŸ”„ 6. è®¢å•æµç¨‹é›†æˆç¤ºä¾‹

### OrderService.javaï¼ˆç¤ºä¾‹ï¼‰

```java
/**
 * åˆ›å»ºè®¢å•å¹¶æ‰£å‡åº“å­˜
 */
@Transactional(rollbackFor = Exception.class)
public Order createOrder(CreateOrderDTO dto) {
    // 1. æ ¡éªŒåº“å­˜
    Sessions session = sessionsService.getById(dto.getSessionId());
    if (session == null) {
        throw new BaseException("åœºæ¬¡ä¸å­˜åœ¨");
    }
    if (session.getStock() < dto.getQuantity()) {
        throw new BaseException("åº“å­˜ä¸è¶³");
    }

    // 2. æ‰£å‡åº“å­˜ï¼ˆä½¿ç”¨åˆ†å¸ƒå¼é” + ä¹è§‚é”ï¼‰
    boolean success = sessionsService.decreaseStock(dto.getSessionId(), dto.getQuantity());
    if (!success) {
        throw new BaseException("åº“å­˜æ‰£å‡å¤±è´¥ï¼Œè¯·é‡è¯•");
    }

    // 3. åˆ›å»ºè®¢å•
    Order order = new Order();
    // ... è®¾ç½®è®¢å•ä¿¡æ¯
    orderMapper.insert(order);

    return order;
}

/**
 * è®¢å•æ”¯ä»˜æˆåŠŸå›è°ƒ
 */
@Transactional(rollbackFor = Exception.class)
public void paySuccess(String orderNo) {
    // 1. æŸ¥è¯¢è®¢å•
    Order order = orderMapper.selectByOrderNo(orderNo);
    if (order == null) {
        throw new BaseException("è®¢å•ä¸å­˜åœ¨");
    }
    if (order.getOrderStatus() == 1) {
        log.warn("è®¢å•å·²æ”¯ä»˜ï¼Œæ— éœ€é‡å¤å¤„ç†ï¼šorderNo={}", orderNo);
        return;
    }

    // 2. æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆåº“å­˜å·²åœ¨åˆ›å»ºè®¢å•æ—¶æ‰£å‡ï¼Œè¿™é‡Œåªéœ€è¦æ›´æ–°è®¢å•çŠ¶æ€ï¼‰
    order.setOrderStatus(1);
    order.setPayTime(LocalDateTime.now());
    orderMapper.update(order);
}

/**
 * è®¢å•å–æ¶ˆï¼ˆå›é€€åº“å­˜ï¼‰
 */
@Transactional(rollbackFor = Exception.class)
public void cancelOrder(Long orderId) {
    // 1. æŸ¥è¯¢è®¢å•
    Order order = orderMapper.selectById(orderId);
    if (order == null) {
        throw new BaseException("è®¢å•ä¸å­˜åœ¨");
    }
    if (order.getOrderStatus() == 1) {
        throw new BaseException("å·²æ”¯ä»˜è®¢å•ä¸èƒ½å–æ¶ˆï¼Œè¯·ç”³è¯·é€€æ¬¾");
    }

    // 2. å›é€€åº“å­˜
    if (order.getSessionId() != null) {
        sessionsService.increaseStock(order.getSessionId(), order.getQuantity());
    }

    // 3. æ›´æ–°è®¢å•çŠ¶æ€
    order.setOrderStatus(3); // å·²å–æ¶ˆ
    orderMapper.update(order);
}
```

---

## âœ… æµ‹è¯•éªŒè¯

### å¹¶å‘æµ‹è¯•ç”¨ä¾‹

```java
@Test
public void testConcurrentDecreaseStock() throws InterruptedException {
    Long sessionId = 1L;
    Integer quantity = 1;
    int threadCount = 100; // 100ä¸ªå¹¶å‘çº¿ç¨‹
    CountDownLatch latch = new CountDownLatch(threadCount);
    AtomicInteger successCount = new AtomicInteger(0);

    // åˆå§‹åŒ–åº“å­˜ä¸º100
    Sessions session = sessionsMapper.selectById(sessionId);
    session.setStock(100);
    sessionsMapper.update(session);

    // å¯åŠ¨100ä¸ªçº¿ç¨‹å¹¶å‘æ‰£å‡åº“å­˜
    for (int i = 0; i < threadCount; i++) {
        new Thread(() -> {
            try {
                boolean success = sessionsService.decreaseStock(sessionId, quantity);
                if (success) {
                    successCount.incrementAndGet();
                }
            } finally {
                latch.countDown();
            }
        }).start();
    }

    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
    latch.await();

    // éªŒè¯ï¼šæˆåŠŸæ‰£å‡æ¬¡æ•°åº”è¯¥ç­‰äºåº“å­˜æ•°é‡ï¼ˆ100æ¬¡ï¼‰
    assertEquals(100, successCount.get());
    
    // éªŒè¯ï¼šæœ€ç»ˆåº“å­˜åº”è¯¥ä¸º0
    Sessions finalSession = sessionsMapper.selectById(sessionId);
    assertEquals(0, finalSession.getStock().intValue());
}
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **åˆ†å¸ƒå¼é”è¶…æ—¶æ—¶é—´**ï¼šæ ¹æ®ä¸šåŠ¡å¤„ç†æ—¶é—´åˆç†è®¾ç½®ï¼ˆå»ºè®® 10-30 ç§’ï¼‰
2. **ä¹è§‚é”é‡è¯•ç­–ç•¥**ï¼šä½¿ç”¨é€’å¢ä¼‘çœ æ—¶é—´ï¼Œé¿å…æ— æ•ˆç«äº‰
3. **åº“å­˜é¢„çƒ­**ï¼šçƒ­é—¨åœºæ¬¡å¯ä»¥æå‰å°†åº“å­˜ä¿¡æ¯åŠ è½½åˆ° Redis ç¼“å­˜
4. **ç›‘æ§å‘Šè­¦**ï¼šç›‘æ§åº“å­˜æ‰£å‡å¤±è´¥ç‡ã€é”ç«äº‰æƒ…å†µç­‰æŒ‡æ ‡

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **åˆ†å¸ƒå¼é”å¿…é¡»è®¾ç½®è¿‡æœŸæ—¶é—´**ï¼Œé˜²æ­¢æ­»é”
2. **é‡Šæ”¾é”æ—¶å¿…é¡»éªŒè¯ value**ï¼Œé˜²æ­¢è¯¯é‡Šæ”¾å…¶ä»–çº¿ç¨‹çš„é”
3. **ä¹è§‚é”é‡è¯•æ¬¡æ•°ä¸å®œè¿‡å¤š**ï¼Œé¿å…é•¿æ—¶é—´å ç”¨èµ„æº
4. **äº‹åŠ¡è¾¹ç•Œ**ï¼šç¡®ä¿åº“å­˜æ‰£å‡å’Œè®¢å•åˆ›å»ºåœ¨åŒä¸€äº‹åŠ¡ä¸­
5. **å¼‚å¸¸å¤„ç†**ï¼šåº“å­˜æ‰£å‡å¤±è´¥æ—¶ï¼Œéœ€è¦å›æ»šå·²åˆ›å»ºçš„æ•°æ®















